{% extends 'base.html' %}
{% load static %}

{% block stylesheet %}
<link rel="stylesheet" href="{% static 'css/datatable/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'css/openlayers/ol.css' %}" type="text/css">
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
<li class="breadcrumb-item active">Event details</li>
{% endblock %}

{% block content %}
{% if motion_data %}
<div id="map" class="map">
  <div id="popup"></div>
</div>
{% endif %}

<script src="{% static 'js/openlayers/ol.js' %}"></script>
<script src="{% static 'js/openlayers/olStationbook.js' %}"></script>

{% if motion_data %}
<div class="mt-2">
<div class="alert alert-primary alert-dismissible fade show" role="alert">
    Click
    <a href="{{ ws_url }}" target="_blank" class="alert-link">here</a> to see raw data used to generate this page.
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

{% if graph %}
<div>
{{ graph|safe }}
</div>
{% endif %}

<h1 class="bg-dark text-white pl-2">Earthquake data</h1>
<div class="container">
    <div class="row">
        <div class="col">
            <p><b>Event ID: </b>{{ motion_data.stations.0.event_id }}</p>
            <p><b>Event time (UTC): </b>{{ motion_data.stations.0.parse_origin_time }}</p>
        </div>
        <div class="col">
            <p><b>Event magnitude: </b>{{ motion_data.stations.0.event_magnitude }} ({{ motion_data.stations.0.event_type }})</p>
            <p><b>Event depth [km]: </b>{{ motion_data.stations.0.event_depth }}</p>
        </div>
        <div class="col">
            <p><b>Event latitude [°]: </b>{{ motion_data.stations.0.event_latitude }}</p>
            <p><b>Event longitude [°]: </b>{{ motion_data.stations.0.event_longitude }}</p>
        </div>
    </div>
</div>
{% for s in motion_data.stations %}
<div class="table-responsive">
<h2 id="{{ s.network_code }}-{{ s.station_code }}" class="bg-dark text-white pl-2">Network {{ s.network_code }}, Station {{ s.station_code }} </h2>
</div>
<div class="container">
    <div class="row">
        <div class="col">
            <p><b>Network code: </b>{{ s.network_code }}</p>
            <p><b>Station code: </b>{{ s.station_code }}</p>
        </div>
        <div class="col">
            <p><b>Station latitude: </b>{{ s.station_latitude }}</p>
            <p><b>Station longitude: </b>{{ s.station_longitude }}</p>
        </div>
        <div class="col">
            <p><b>Station elevation: </b>{{ s.station_elevation }}</p>
            <p><b>Epicentral distance: </b>{{ s.epicentral_distance }}</p>
        </div>
    </div>
</div>
<table class="table-sm mb-5" cellspacing="0" width="100%">
    <thead>
        <tr>
            <th>Channel</th>
            <th>PGA [cm/s2]</th>
            <th>PGV [cm/s]</th>
            <th>Azimuth</th>
            <th>Dip</th>
            <th>Depth</th>
            <th>Sensor unit</th>
            <th>Lower frequency</th>
            <th>Upper frequency</th>
        </tr>
    </thead>
    <tbody>
        {% for sc in s.sensor_channels %}
        <tr>
            <td>{{ sc.channel_code }}</td>
            <td>{{ sc.pga_value }}</td>
            <td>{{ sc.pgv_value }}</td>
            <td>{{ sc.sensor_azimuth }}</td>
            <td>{{ sc.sensor_dip }}</td>
            <td>{{ sc.sensor_depth }}</td>
            <td>{{ sc.sensor_unit }}</td>
            <td>{{ sc.corner_freq_lower }}</td>
            <td>{{ sc.corner_freq_upper }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<a href="#" class="float-right mb-2">Top of the page</a>

<script type="text/javascript">
var latitude=parseFloat("{{ s.station_latitude }}"),longitude=parseFloat("{{ s.station_longitude }}"),stationCode="{{ s.station_code }}",networkCode="{{ s.network_code }}",markerPath="{% static 'img/markers/marker-red.png' %}";if(!isNaN(latitude)&&!isNaN(longitude)){var point=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([longitude,latitude])),name:`<b>Network code: </b>${networkCode}<br><b>Station code: </b>${stationCode}\n<br><b>Latitude: </b>${latitude}\n<br><b>Longitude: </b>${longitude}\n<br><a href="#${networkCode}-${stationCode}">Scroll to this station</a>`});point.setStyle(new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,0],anchorXUnits:"fraction",anchorYUnits:"pixels",src:markerPath})})),vectorSource.addFeature(point)}
</script>
{% endfor %}
{% else %}
<p>
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">No data</h4>
        <p>Event details not available for given event:</p>
        <a href="{{ ws_url }}" class="alert-link">{{ ws_url }}</a>
    </div>
</p>
{% endif %}
</div>

{% block javascript %}
<script src="{% static 'js/datatable/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'js/datatable/dataTables.bootstrap4.min.js' %}"></script>
{% endblock %}

<script type="text/javascript">
var event_latitude=parseFloat("{{ motion_data.stations.0.event_latitude }}"),event_longitude=parseFloat("{{ motion_data.stations.0.event_longitude }}"),event_depth=parseFloat("{{ motion_data.stations.0.event_depth }}"),event_magnitude=parseFloat("{{ motion_data.stations.0.event_magnitude }}");if(!isNaN(event_latitude)&&!isNaN(event_longitude)){var point=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([event_longitude,event_latitude]))});point.setStyle(new ol.style.Style({image:new ol.style.Circle({radius:event_magnitude**2/2,fill:new ol.style.Fill({color:getEventColor(event_magnitude)}),stroke:new ol.style.Stroke({color:'#000000',width:1})})})),vectorSource.addFeature(point)}
var latitude=parseFloat("{{ motion_data.stations.0.event_latitude }}"),longitude=parseFloat("{{ motion_data.stations.0.event_longitude }}");map.getView().setCenter(ol.proj.transform([longitude,latitude],"EPSG:4326","EPSG:3857")),map.getView().setZoom(8);
</script>
{% endblock %}